<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacEmu Web - WebRTC Streaming</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="logo">
            <img src="Apple.svg" alt="Apple" style="height: 2em; margin-right: 0.5em;">
            <img id="processor-logo" src="Motorola.svg" alt="Processor" style="height: 2em; margin-right: 0.5em;">
            <h1 id="emulator-title">Macintosh</h1>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span id="connection-icon">üîå</span>
            </div>
            <div class="status-item">
                <span id="emulator-icon">üíª</span>
            </div>
            <div class="status-item" id="fps-display">
                <span>üé¨</span>
                <span>--</span>
            </div>
            <div class="status-item" id="bitrate-display">
                <span>üìä</span>
                <span>-- kbps</span>
            </div>
        </div>

        <div class="controls">
            <div class="status-item">
                <span style="font-size: 1.1em;">üìê</span>
                <span id="header-resolution">-- x --</span>
            </div>
            <div class="codec-selector">
                <label for="codec-select">Codec:</label>
                <select id="codec-select" onchange="changeCodec()" disabled>
                    <option value="png">PNG</option>
                    <option value="h264">H.264</option>
                    <option value="av1">AV1</option>
                    <option value="vp9">VP9</option>
                </select>
            </div>
            <div class="codec-selector">
                <label for="mouse-mode-select">Mouse:</label>
                <select id="mouse-mode-select" onchange="changeMouseMode()">
                    <option value="relative" selected>Relative</option>
                    <option value="absolute">Absolute</option>
                </select>
            </div>
            <button class="btn" id="config-btn" onclick="openConfig()">Settings</button>
            <button class="btn success" id="start-btn" onclick="startEmulator()">Start</button>
            <button class="btn danger" id="stop-btn" onclick="stopEmulator()">Stop</button>
            <button class="btn" id="debug-toggle" onclick="toggleDebugPanel()">Debug</button>
            <button class="btn" onclick="toggleFullscreen()">Fullscreen</button>
        </div>
    </header>

    <main>
        <div id="video-section">
            <div id="display-container">
                <video id="display" autoplay playsinline muted></video>
                <canvas id="display-canvas" style="display: none;"></canvas>
                <canvas id="cursor-overlay" style="position: absolute; top: 0; left: 0; pointer-events: none; display: none;"></canvas>
                <div class="overlay" id="overlay">
                    <div class="overlay-content">
                        <div class="spinner" id="spinner"></div>
                        <h2 id="overlay-title">Connecting to Basilisk II</h2>
                        <p id="overlay-status">Initializing...</p>

                        <div class="connection-steps" id="connection-steps">
                            <div class="step" id="step-ws">
                                <span class="step-icon">1</span>
                                <span>WebSocket signaling</span>
                            </div>
                            <div class="step" id="step-offer">
                                <span class="step-icon">2</span>
                                <span>Receiving offer</span>
                            </div>
                            <div class="step" id="step-ice">
                                <span class="step-icon">3</span>
                                <span>ICE negotiation</span>
                            </div>
                            <div class="step" id="step-track">
                                <span class="step-icon">4</span>
                                <span>Video track</span>
                            </div>
                            <div class="step" id="step-frames">
                                <span class="step-icon">5</span>
                                <span>Receiving frames</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="debug-panel">
            <div class="debug-header">
                <h3>Debug Console</h3>
                <button class="clear-btn" onclick="clearLog()">Clear</button>
            </div>
            <div class="debug-tabs">
                <div class="debug-tab active" onclick="showDebugTab('log')">Log</div>
                <div class="debug-tab" onclick="showDebugTab('stats')">Stats</div>
                <div class="debug-tab" onclick="showDebugTab('webrtc')">WebRTC</div>
            </div>
            <div class="debug-content">
                <div class="debug-pane active" id="log-pane">
                    <div id="debug-log"></div>
                </div>
                <div class="debug-pane" id="stats-pane">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="label">Video FPS</div>
                            <div class="value" id="stat-fps">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Bitrate</div>
                            <div class="value" id="stat-bitrate">-- kbps</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Resolution</div>
                            <div class="value" id="stat-resolution">-- x --</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Frames Decoded</div>
                            <div class="value" id="stat-frames">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Packets Lost</div>
                            <div class="value" id="stat-packets-lost">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Jitter</div>
                            <div class="value" id="stat-jitter">-- ms</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Mouse Latency</div>
                            <div class="value" id="stat-mouse-latency">-- ms</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Video Latency</div>
                            <div class="value" id="stat-video-latency">-- ms</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">RTT</div>
                            <div class="value" id="stat-rtt">-- ms</div>
                        </div>
                    </div>
                    <!-- Ping Breakdown Section -->
                    <div id="ping-breakdown-section">
                        <h4 style="margin-top: 15px; margin-bottom: 10px; color: #888;">Ping Latency Breakdown (8-stage)</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="label">Total RTT</div>
                                <div class="value" id="stat-ping-total">-- ms</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Network</div>
                                <div class="value" id="stat-ping-network">-- ms</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">IPC</div>
                                <div class="value" id="stat-ping-ipc">-- ms</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Emulator</div>
                                <div class="value" id="stat-ping-emulator">-- ms</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Wake</div>
                                <div class="value" id="stat-ping-wake">-- ms</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Encode</div>
                                <div class="value" id="stat-ping-encode">-- ms</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Send Prep</div>
                                <div class="value" id="stat-ping-send">-- ms</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="debug-pane" id="webrtc-pane">
                    <div class="webrtc-section">
                        <h4>Connection State</h4>
                        <div class="webrtc-info">
                            <div class="webrtc-state">
                                <span class="key">WebSocket</span>
                                <span class="value" id="ws-state">Closed</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">Peer Connection</span>
                                <span class="value" id="pc-state">None</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">ICE Connection</span>
                                <span class="value" id="ice-state">None</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">ICE Gathering</span>
                                <span class="value" id="ice-gathering-state">None</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">Signaling</span>
                                <span class="value" id="signaling-state">None</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">Data Channel</span>
                                <span class="value" id="dc-state">None</span>
                            </div>
                        </div>
                    </div>
                    <div class="webrtc-section">
                        <h4>Video Track</h4>
                        <div class="webrtc-info">
                            <div class="webrtc-state">
                                <span class="key">Track State</span>
                                <span class="value" id="track-state">None</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">Track Enabled</span>
                                <span class="value" id="track-enabled">--</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">Track Muted</span>
                                <span class="value" id="track-muted">--</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">Video Size</span>
                                <span class="value" id="video-size">-- x --</span>
                            </div>
                        </div>
                    </div>
                    <div class="webrtc-section">
                        <h4>Audio Track</h4>
                        <div class="webrtc-info">
                            <div class="webrtc-state">
                                <span class="key">Track State</span>
                                <span class="value" id="audio-track-state">None</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">Track Enabled</span>
                                <span class="value" id="audio-track-enabled">--</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">Track Muted</span>
                                <span class="value" id="audio-track-muted">--</span>
                            </div>
                            <div class="webrtc-state">
                                <span class="key">Format</span>
                                <span class="value" id="audio-format">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="webrtc-section">
                        <h4>SDP Info</h4>
                        <div class="webrtc-info" style="max-height: 150px; overflow-y: auto;">
                            <pre id="sdp-info" style="font-size: 10px; white-space: pre-wrap; word-break: break-all;">No SDP yet</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <span>Basilisk II WebRTC Streaming</span>
        <span id="resolution">-- x --</span>
    </footer>

    <!-- Configuration Modal -->
    <div class="modal-overlay" id="config-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Emulator Settings</h2>
                <button class="modal-close" onclick="closeConfig()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Emulator Type</label>
                    <select id="cfg-emulator" onchange="onEmulatorChange()">
                        <option value="basilisk">68k (Mac OS 7.x)</option>
                        <option value="sheepshaver">PPC (Mac OS 8/9)</option>
                    </select>
                    <small class="help-text">Requires restart to change emulator</small>
                </div>

                <div class="form-group">
                    <label>ROM File</label>
                    <select id="cfg-rom" onchange="onRomChange()">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Disk Images</label>
                    <div id="disk-list" class="disk-checkbox-list"><div class="empty-state">Loading...</div></div>
                </div>

                <div class="form-group">
                    <label>CD-ROM Images</label>
                    <div id="cdrom-list" class="disk-checkbox-list"><div class="empty-state">Loading...</div></div>
                </div>

                <div class="form-group">
                    <label>RAM Size</label>
                    <select id="cfg-ram">
                        <option value="8">8 MB</option>
                        <option value="16">16 MB</option>
                        <option value="32" selected>32 MB</option>
                        <option value="64">64 MB</option>
                        <option value="128">128 MB</option>
                        <option value="256">256 MB</option>
                        <option value="512">512 MB</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Screen Resolution</label>
                    <select id="cfg-screen">
                        <option value="640x480">640 x 480</option>
                        <option value="800x600" selected>800 x 600</option>
                        <option value="1024x768">1024 x 768</option>
                        <option value="1280x1024">1280 x 1024</option>
                        <option value="1920x1080">1920 x 1080</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Video Codec</label>
                    <select id="cfg-webcodec">
                        <option value="png" selected>PNG (good for dithered, uses dirty rects)</option>
                        <option value="av1">AV1 (best for dithered, modern browsers)</option>
                        <option value="vp9">VP9 (great for UI, works via WebCodecs)</option>
                        <option value="h264">H.264 (avoid for dithered content)</option>
                    </select>
                </div>

                <div class="advanced-toggle" onclick="toggleAdvanced()">
                    <span class="arrow">&#9654;</span>
                    <span>Advanced Settings</span>
                </div>
                <div class="advanced-content" id="advanced-settings">
                    <!-- Basilisk II specific settings -->
                    <div id="basilisk-settings">
                        <div class="form-row">
                            <div class="form-group">
                                <label>CPU Type</label>
                                <select id="cfg-cpu">
                                    <option value="2">68020</option>
                                    <option value="3">68030</option>
                                    <option value="4" selected>68040</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mac Model</label>
                                <select id="cfg-model">
                                    <option value="5">Mac II</option>
                                    <option value="14" selected>Quadra 900</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-fpu" checked>
                                    <label for="cfg-fpu">Enable FPU (68881)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-jit" checked>
                                    <label for="cfg-jit">Enable JIT Compiler</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-idlewait-b2" checked>
                                    <label for="cfg-idlewait-b2">Don't Use CPU When Idle</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-ignoresegv" checked>
                                    <label for="cfg-ignoresegv">Ignore Illegal Memory Access</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SheepShaver specific settings -->
                    <div id="sheepshaver-settings" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-fpu-ss" checked>
                                    <label for="cfg-fpu-ss">Enable FPU</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-jit-ss" checked>
                                    <label for="cfg-jit-ss">Enable PPC JIT Compiler</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-jit68k" checked>
                                    <label for="cfg-jit68k">Enable 68k JIT (DR Emulator)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-idlewait" checked>
                                    <label for="cfg-idlewait">Don't Use CPU When Idle</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-ignoresegv-ss" checked>
                                    <label for="cfg-ignoresegv-ss">Ignore SIGSEGV</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cfg-ignoreillegal" checked>
                                    <label for="cfg-ignoreillegal">Ignore Illegal Instructions</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Common settings -->
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="cfg-sound" checked>
                            <label for="cfg-sound">Enable Sound</label>
                        </div>
                    </div>
                </div>

                <div class="note-banner">
                    Changes require emulator restart to take effect.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeConfig()">Cancel</button>
                <button class="btn success" onclick="saveConfig()">Save &amp; Restart</button>
            </div>
        </div>
    </div>

    <!-- Emulator Status Bar -->
    <div class="emu-status" id="emu-status">
        <span><span class="dot" id="dot-running"></span> Process</span>
        <span><span class="dot" id="dot-connected"></span> IPC</span>
        <span id="emu-pid">PID: -</span>
    </div>

    <script src="client.js"></script>
</body>
</html>
